<!DOCTYPE html>
<html>
<head>
    <title>Transaction Page - Shell Gas Station</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <style>
        body { background-color: white; display: flex; flex-direction: column; min-height: 100vh; }
        .w3-bar { background-color: #d50000 !important; color: white; }
        .w3-button { color: white !important; }
        .content { flex: 1; padding: 60px 20px 20px; }
        .card { background-color: #e0e0e0; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .receipt-btn { background-color: #d50000; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; display: block; text-align: center; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<!-- Navbar -->
<div class="w3-top">
    <div class="w3-bar w3-card">
        <a href="#" class="w3-bar-item w3-button"><b>Shell</b> Gas Station</a>
        <a href="index.html" class="w3-bar-item w3-button w3-right">Home</a>
    </div>
</div>

<!-- Transaction Details -->
<div class="w3-content w3-padding content" style="max-width:600px">
    <h2 class="w3-margin-top">Transaction Summary</h2>
    <div class="card">
        <label for="product"><strong>Gas Type:</strong></label>
        <select id="product" class="w3-input w3-border" onchange="updateTotal()">
            <option value="Premium Gas" data-price="65.75">Premium Gas - ₱65.75</option>
            <option value="Unleaded" data-price="60.50">Unleaded - ₱60.50</option>
            <option value="Diesel" data-price="55.25">Diesel - ₱55.25</option>
        </select>

        <label for="quantity"><strong>Quantity (liters):</strong></label>
        <input type="number" id="quantity" class="w3-input w3-border" min="1" value="1" oninput="updateTotal()">

        <label for="branch"><strong>Branch:</strong></label>
        <input type="text" id="branch" class="w3-input w3-border" value="Branch A">

        <p><strong>Total Cost:</strong> ₱<span id="totalAmount">0.00</span></p>
    </div>
    <button class="receipt-btn" onclick="proceedToReceipt()">Confirm Order</button>
</div>

<script>
    const supabaseUrl = "https://nyfcjxeebjzejsutbgub.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    function updateTotal() {
        let product = document.getElementById("product");
        let quantity = parseInt(document.getElementById("quantity").value) || 1;
        let price = parseFloat(product.options[product.selectedIndex].getAttribute("data-price"));
        document.getElementById("totalAmount").textContent = (quantity * price).toFixed(2);
    }
    updateTotal();

    async function proceedToReceipt() {
        const productName = document.getElementById("product").value;
        const quantity = parseInt(document.getElementById("quantity").value);
        const branch = document.getElementById("branch").value;
        const totalAmount = parseFloat(document.getElementById("totalAmount").textContent);

        // Get Employee ID
        let { data: employeeData, error: employeeError } = await supabase
            .from("Employee")
            .select("EmployeeID")
            .eq("emp_branch", branch)
            .limit(1)
            .single();

        if (employeeError || !employeeData) {
            alert("Employee not found!");
            return;
        }
        const employeeID = employeeData.EmployeeID;

        // Get Supplier ID (assuming one supplier)
        let { data: supplierData, error: supplierError } = await supabase
            .from("Supplier")
            .select("SupplierID")
            .limit(1)
            .single();

        if (supplierError || !supplierData) {
            alert("Supplier not found!");
            return;
        }
        const supplierID = supplierData.SupplierID;

        // Insert order into Orders table
        let { data: orderData, error: orderError } = await supabase
            .from("Orders")
            .insert([
                {
                    SupplierID: supplierID,
                    EmployeeID: employeeID,
                    OrderDate: new Date().toISOString(),
                    TotalAmount: totalAmount,
                },
            ])
            .select()
            .single();

        if (orderError || !orderData) {
            alert("Order failed!");
            return;
        }
        const orderID = orderData.orderID;

        // Get Product ID
        let { data: productData, error: productError } = await supabase
            .from("Product")
            .select("productID")
            .eq("ProductName", productName)
            .limit(1)
            .single();

        if (productError || !productData) {
            alert("Product not found!");
            return;
        }
        const productID = productData.productID;

        // Insert into Orders_Has_Product table
        let { error: orderProductError } = await supabase
            .from("Orders_Has_Product")
            .insert([
                {
                    orders_orderID: orderID,
                    product_productID: productID,
                    quantity: quantity,
                },
            ]);

        if (orderProductError) {
            alert("Failed to add product to order!");
            return;
        }

        // Redirect to receipt page
        window.location.href = `receipt.html?productName=${encodeURIComponent(productName)}&quantity=${quantity}&branch=${encodeURIComponent(branch)}&totalAmount=${totalAmount}`;
    }
</script>

</body>
</html>

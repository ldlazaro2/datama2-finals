<!DOCTYPE html>
<html>
<head>
    <title>Transaction Page - Shell Gas Station</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <style>
        body { background-color: white; display: flex; flex-direction: column; min-height: 100vh; }
        .w3-bar { background-color: #d50000 !important; color: white; }
        .w3-button { color: white !important; }
        .content { flex: 1; padding: 60px 20px 20px; }
        .card { background-color: #e0e0e0; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .receipt-btn { background-color: #d50000; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; display: block; text-align: center; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<!-- Navbar -->
<div class="w3-top">
    <div class="w3-bar w3-card">
        <a href="#" class="w3-bar-item w3-button"><b>Shell</b> Gas Station</a>
        <a href="index.html" class="w3-bar-item w3-button w3-right">Home</a>
    </div>
</div>

<!-- Transaction Details -->
<div class="w3-content w3-padding content" style="max-width:600px">
    <h2 class="w3-margin-top">Transaction Summary</h2>
    <div class="card">
        <label for="product"><strong>Gas Type:</strong></label>
        <select id="product" class="w3-input w3-border" onchange="updateTotal()">
            <option value="Premium Gas" data-price="65.75">Premium Gas - â‚±65.75</option>
            <option value="Unleaded" data-price="60.50">Unleaded - â‚±60.50</option>
            <option value="Diesel" data-price="55.25">Diesel - â‚±55.25</option>
        </select>

        <label for="quantity"><strong>Quantity (liters):</strong></label>
        <input type="number" id="quantity" class="w3-input w3-border" min="1" value="1" oninput="updateTotal()">

        <label for="branch"><strong>Branch:</strong></label>
        <input type="text" id="branch" class="w3-input w3-border" value="Branch A">

        <p><strong>Total Cost:</strong> â‚±<span id="totalAmount">0.00</span></p>
    </div>
    <button class="receipt-btn" onclick="proceedToReceipt()">Confirm Order</button>
</div>

<script>
    // ðŸ›  FIX: Define Supabase before using it
    const supabaseUrl = "https://nyfcjxeebjzejsutbgub.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55ZmNqeGVlYmp6ZWpzdXRiZ3ViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA5MjI0MjUsImV4cCI6MjA1NjQ5ODQyNX0.OEkEIPw-AAtYwbp8BrZP-CfZNQ8WqZIwjVwunUwV1QE";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // ðŸ›  FIX: Define updateTotal() before using it
    function updateTotal() {
        let product = document.getElementById("product");
        let quantity = parseInt(document.getElementById("quantity").value) || 1;
        let price = parseFloat(product.options[product.selectedIndex].getAttribute("data-price"));
        document.getElementById("totalAmount").textContent = (quantity * price).toFixed(2);
    }
    updateTotal();

    async function proceedToReceipt() {
        try {
            // Fetch input values
            const productName = document.getElementById("product").value;
            const quantity = parseInt(document.getElementById("quantity").value);
            const branch = document.getElementById("branch").value;
            const totalAmount = parseFloat(document.getElementById("totalAmount").textContent);
            
            // Step 1: Fetch EmployeeID based on Branch
            const { data: employeeData, error: employeeError } = await supabase
                .from("Employee")
                .select("EmployeeID")
                .eq("emp_branch", branch)
                .limit(1)
                .single();

            if (employeeError || !employeeData) {
                console.error("Employee Error:", employeeError);
                alert("Employee not found for this branch!");
                return;
            }
            const employeeID = employeeData.EmployeeID;

            // Step 2: Fetch SupplierID (assuming first supplier)
            const { data: supplierData, error: supplierError } = await supabase
                .from("Supplier")
                .select("SupplierID")
                .limit(1)
                .single();

            if (supplierError || !supplierData) {
                console.error("Supplier Error:", supplierError);
                alert("Supplier not found!");
                return;
            }
            const supplierID = supplierData.SupplierID;

            // Step 3: Insert order into Orders table
            const { data: orderData, error: orderError } = await supabase
                .from("Orders")
                .insert([
                    {
                        SupplierID: supplierID,
                        EmployeeID: employeeID,
                        OrderDate: new Date().toISOString(),
                        TotalAmount: totalAmount,
                    },
                ])
                .select()
                .single();

            if (orderError || !orderData) {
                console.error("Order Insert Error:", orderError);
                alert("Failed to create order!");
                return;
            }
            const orderID = orderData.orderID;

            // Step 4: Fetch ProductID
            const { data: productData, error: productError } = await supabase
                .from("Product")
                .select("productID")
                .eq("ProductName", productName)
                .limit(1)
                .single();

            if (productError || !productData) {
                console.error("Product Error:", productError);
                alert("Product not found!");
                return;
            }
            const productID = productData.productID;

            // Step 5: Insert into Orders_Has_Product table
            const { error: orderProductError } = await supabase
                .from("Orders_Has_Product")
                .insert([
                    {
                        orders_orderID: orderID,
                        product_productID: productID,
                        quantity: quantity,
                    },
                ]);

            if (orderProductError) {
                console.error("Orders_Has_Product Insert Error:", orderProductError);
                alert("Failed to add product to order!");
                return;
            }

            // Step 6: Redirect to receipt page
            const receiptURL = `receipt.html?productName=${encodeURIComponent(productName)}&quantity=${quantity}&branch=${encodeURIComponent(branch)}&totalAmount=${totalAmount}`;
            console.log("Redirecting to:", receiptURL);
            window.location.href = receiptURL;

        } catch (error) {
            console.error("Unexpected Error:", error);
            alert("Something went wrong, please try again.");
        }
    }
</script>

</body>
</html>


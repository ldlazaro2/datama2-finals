<!DOCTYPE html>
<html>
<head>
    <title>Transaction Page - Shell Gas Station</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <style>
        body { background-color: white; display: flex; flex-direction: column; min-height: 100vh; }
        .w3-bar { background-color: #d50000 !important; color: white; }
        .w3-button { color: white !important; }
        .content { flex: 1; padding: 60px 20px 20px; }
        .card { background-color: #e0e0e0; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .receipt-btn { background-color: #d50000; color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; display: block; text-align: center; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<!-- Navbar -->
<div class="w3-top">
    <div class="w3-bar w3-card">
        <a href="#" class="w3-bar-item w3-button"><b>Shell</b> Gas Station</a>
        <a href="index.html" class="w3-bar-item w3-button w3-right">Home</a>
    </div>
</div>

<!-- Transaction Details -->
<div class="w3-content w3-padding content" style="max-width:600px">
    <h2 class="w3-margin-top">Transaction Summary</h2>
    <div class="card">
        <label for="gasType"><strong>Gas Type:</strong></label>
        <select id="gasType" class="w3-input w3-border">
            <option value="1">Premium Gas - ₱65.75</option>
            <option value="2">Unleaded - ₱60.50</option>
            <option value="3">Diesel - ₱55.25</option>
        </select>

        <label for="quantity"><strong>Quantity (liters):</strong></label>
        <input type="number" id="quantity" class="w3-input w3-border" min="1" value="1">

        <label for="branch"><strong>Branch:</strong></label>
        <input type="text" id="branch" class="w3-input w3-border" value="Branch A">

        <p><strong>Total Cost:</strong> ₱<span id="totalAmount">0.00</span></p>
    </div>
    <button class="receipt-btn" onclick="processTransaction()">Confirm Order</button>
</div>

<script>
    const supabaseUrl = "https://vdefkqccbueaoylrlsqx.supabase.co";
    const supabaseKey = "YOUR_SUPABASE_ANON_KEY";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const gasPrices = { "1": 65.75, "2": 60.50, "3": 55.25 };
    const supplierId = 1;  // Assuming a fixed supplier ID for Shell products
    const employeeId = 1;  // Replace with logged-in employee's ID

    document.getElementById("quantity").addEventListener("input", updateTotal);
    document.getElementById("gasType").addEventListener("change", updateTotal);

    function updateTotal() {
        const gasType = document.getElementById("gasType").value;
        const quantity = parseFloat(document.getElementById("quantity").value);
        const totalAmount = gasPrices[gasType] * quantity;
        document.getElementById("totalAmount").textContent = totalAmount.toFixed(2);
    }

    async function processTransaction() {
        const gasType = document.getElementById("gasType").value;
        const quantity = document.getElementById("quantity").value;
        const totalAmount = document.getElementById("totalAmount").textContent;
        const orderDate = new Date().toISOString();

        // Insert into Orders table
        const { data: order, error: orderError } = await supabase
            .from("orders")
            .insert([{ supplierid: supplierId, employeeid: employeeId, orderdate: orderDate, totalamount: totalAmount }])
            .select()
            .single();

        if (orderError) {
            console.error("Error inserting order:", orderError.message);
            return;
        }

        // Insert into Orders_Has_Product table
        const { error: productError } = await supabase
            .from("orders_has_product")
            .insert([{ orders_orderid: order.orderid, product_productid: gasType, quantity: quantity }]);

        if (productError) {
            console.error("Error inserting order product:", productError.message);
            return;
        }

        alert("Order successfully placed!");
        window.location.href = `receipt.html?orderid=${order.orderid}`;
    }
</script>

</body>
</html>
